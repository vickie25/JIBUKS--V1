generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                    Int                    @id @default(autoincrement())
  name                  String                 @unique
  slug                  String                 @unique
  metadata              Json?
  createdAt             DateTime               @default(now()) @map("created_at")
  ownerEmail            String?                @map("owner_email")
  updatedAt             DateTime               @default(now()) @updatedAt @map("updated_at")
  budgets               Budget[]
  goals                 Goal[]
  users                 User[]
  transactions          Transaction[]
  categories            Category[]
  paymentMethods        PaymentMethod[]
  recurringTransactions RecurringTransaction[]

  @@map("tenants")
}

model User {
  id                    Int                    @id @default(autoincrement())
  name                  String?
  email                 String                 @unique
  password              String?
  role                  Role                   @default(MEMBER)
  auth0Id               String?                @unique @map("auth0_id")
  avatarUrl             String?                @map("avatar_url")
  createdAt             DateTime               @default(now()) @map("created_at")
  isActive              Boolean                @default(true) @map("is_active")
  permissions           Json?
  tenantId              Int?                   @map("tenant_id")
  updatedAt             DateTime               @default(now()) @updatedAt @map("updated_at")
  assignedGoals         Goal[]
  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]
  tenant                Tenant?                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  resetPasswordOtp      String?                @map("reset_password_otp")
  resetPasswordExpires  DateTime?              @map("reset_password_expires")

  @@index([tenantId])
  @@index([auth0Id])
  @@map("users")
}

model Goal {
  id                  Int        @id @default(autoincrement())
  tenantId            Int
  name                String
  targetAmount        Decimal
  currentAmount       Decimal    @default(0)
  targetDate          DateTime?
  monthlyContribution Decimal?
  assignedUserId      Int?
  status              GoalStatus @default(ACTIVE)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  assignedUser        User?      @relation(fields: [assignedUserId], references: [id])
  tenant              Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("goals")
}

model Budget {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  category  String
  amount    Decimal
  month     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("budgets")
}

enum Role {
  OWNER
  ADMIN
  PARENT
  CHILD
  MEMBER
}

model Transaction {
  id            Int             @id @default(autoincrement())
  tenantId      Int             @map("tenant_id")
  userId        Int             @map("user_id")
  type          TransactionType
  amount        Decimal
  category      String
  description   String?
  date          DateTime        @default(now())
  paymentMethod String?         @map("payment_method")
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([date])
  @@map("transactions")
}

model Category {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  name      String
  type      String   // 'income' or 'expense'
  icon      String?
  color     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name, type])
  @@map("categories")
}

model PaymentMethod {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  name      String
  type      String   // 'cash', 'bank', 'mobile_money', 'card', etc.
  details   Json?    // Store account numbers, etc.
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model RecurringTransaction {
  id            Int             @id @default(autoincrement())
  tenantId      Int             @map("tenant_id")
  userId        Int             @map("user_id")
  type          TransactionType
  amount        Decimal
  category      String
  description   String?
  frequency     String          // 'daily', 'weekly', 'monthly', 'yearly'
  startDate     DateTime        @map("start_date")
  endDate       DateTime?       @map("end_date")
  lastProcessed DateTime?       @map("last_processed")
  isActive      Boolean         @default(true) @map("is_active")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("recurring_transactions")
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TransactionType {
  INCOME
  EXPENSE
}
