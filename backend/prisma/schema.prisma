generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant Types
enum TenantType {
  FAMILY
  BUSINESS
}

model Tenant {
  id                    Int                    @id @default(autoincrement())
  name                  String                 @unique
  slug                  String                 @unique
  tenantType            TenantType             @default(FAMILY) @map("tenant_type")
  metadata              Json?
  createdAt             DateTime               @default(now()) @map("created_at")
  ownerEmail            String?                @map("owner_email")
  updatedAt             DateTime               @default(now()) @updatedAt @map("updated_at")
  budgets               Budget[]
  goals                 Goal[]
  users                 User[]
  transactions          Transaction[]
  categories            Category[]
  paymentMethods        PaymentMethod[]
  recurringTransactions RecurringTransaction[]
  accounts              Account[]
  journals              Journal[]
  vendors               Vendor[]
  purchases             Purchase[]
  inventoryItems        InventoryItem[]
  stockMovements        StockMovement[]
  bankTransactions      BankTransaction[]
  fixedAssets           FixedAsset[]
  customers             Customer[]
  invoices              Invoice[]
  receipts              Receipt[]
  expenses              Expense[]
  expenseCategories     ExpenseCategory[]
  vendorTags            VendorTag[]
  paymentAccounts       PaymentAccount[]
  cheques               Cheque[]
  transfers             Transfer[]
  loans                 Loan[]

  @@map("tenants")
}

// ============================================
// ACCOUNTING MODELS - Double-Entry Bookkeeping
// ============================================

// Account Types for Chart of Accounts
enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

// Chart of Accounts
model Account {
  id              Int           @id @default(autoincrement())
  tenantId        Int           @map("tenant_id")
  code            String        // Account code (e.g., '1000', '4010')
  name            String        // Display name (e.g., 'Cash on Hand')
  type            AccountType   // ASSET, LIABILITY, EQUITY, INCOME, EXPENSE
  
  // NEW: Bulletproof Chart of Accounts fields
  subtype         String?       // "cash", "bank", "ar", "ap", "tax", "fixed_asset", "cogs", "operating_expense"
  systemTag       String?       @map("system_tag") // "CASH", "BANK", "AP", "AR" - for reliable lookups without hardcoding IDs
  isControl       Boolean       @default(false) @map("is_control") // Control accounts (AR/AP) - subledger required
  allowDirectPost Boolean       @default(true) @map("allow_direct_post") // False for control accounts
  isPaymentEligible Boolean     @default(false) @map("is_payment_eligible") // True for Cash/Bank only
  
  description     String?
  parentId        Int?          @map("parent_id")
  isSystem        Boolean       @default(false) @map("is_system") // System accounts can't be deleted
  isContra        Boolean       @default(false) @map("is_contra") // Contra accounts (negative balances)
  isActive        Boolean       @default(true) @map("is_active")
  currency        String        @default("KES")
  metadata        Json?         // Flexible field for Loan Terms (rate, installment, dates) or Bank Details
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent          Account?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        Account[]     @relation("AccountHierarchy")
  journalLines    JournalLine[]
  invoiceItems    InvoiceItem[]
  invoicePayments InvoicePayment[]
  expenses        Expense[]
  expenseCategories ExpenseCategory[]
  paymentAccounts PaymentAccount[]
  transfersFrom   Transfer[]    @relation("TransferFromAccount")
  transfersTo     Transfer[]    @relation("TransferToAccount")
  // Fixed Assets relations
  fixedAssets       FixedAsset[]  @relation("AssetAccount")
  assetsPaidFrom    FixedAsset[]  @relation("PaidFromAccount")
  assetsFinanced    FixedAsset[]  @relation("FinanceAccount")
  assetsAccumDep    FixedAsset[]  @relation("AccumDepAccount")
  assetsDepExp      FixedAsset[]  @relation("DepreciationExpAccount")
  assetsDisposal    FixedAsset[]  @relation("DisposalAccount")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([type])
  @@index([systemTag])
  @@map("accounts")
}


// Payment Accounts Registry
// Operational metadata for Cash/Bank accounts used in payments
model PaymentAccount {
  id                Int      @id @default(autoincrement())
  tenantId          Int      @map("tenant_id")
  accountId         Int      @map("account_id")
  name              String   // User-friendly name: "Petty Cash", "KCB Main Account"
  institution       String?  // "KCB Bank", "Equity Bank", "M-Pesa"
  accountNumber     String?  @map("account_number")
  openingBalance    Decimal  @default(0) @map("opening_balance")
  reconcileEnabled  Boolean  @default(true) @map("reconcile_enabled")
  status            String   @default("active") // "active" | "archived"
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  @@unique([tenantId, accountId])
  @@index([tenantId])
  @@index([status])
  @@map("payment_accounts")
}


// Journal Entry (Header)
model Journal {
  id                  Int           @id @default(autoincrement())
  tenantId            Int           @map("tenant_id")
  reference           String?       // Optional reference number
  date                DateTime      @default(now())
  description         String
  status              JournalStatus @default(POSTED)
  createdById         Int?          @map("created_by_id")
  invoiceId           Int?          @map("invoice_id")       // Link to invoice (sale posting)
  invoicePaymentId    Int?          @map("invoice_payment_id") // Link to payment (payment posting)
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines               JournalLine[]
  transactions        Transaction[]
  purchases           Purchase[]
  purchasePayments    PurchasePayment[]
  stockMovements      StockMovement[]
  bankTransactions    BankTransaction[]
  assetDepreciations   AssetDepreciation[] @relation("DepreciationJournal")
  invoice             Invoice?           @relation(fields: [invoiceId], references: [id])
  invoicePayment      InvoicePayment?    @relation(fields: [invoicePaymentId], references: [id])
  transfers           Transfer[]
  loanTransactions    LoanTransaction[]

  @@index([tenantId])
  @@index([date])
  @@index([invoiceId])
  @@index([invoicePaymentId])
  @@map("journals")
}

enum JournalStatus {
  DRAFT
  POSTED
  VOID
}

// Journal Line (Debit/Credit Entry)
// Each line connects to ONE account with either a debit or credit amount
// A journal entry has multiple lines that must balance (total debits = total credits)
model JournalLine {
  id              Int           @id @default(autoincrement())
  journalId       Int           @map("journal_id")
  accountId       Int           @map("account_id")
  debit           Decimal       @default(0) // Debit amount
  credit          Decimal       @default(0) // Credit amount
  description     String?
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  journal         Journal       @relation(fields: [journalId], references: [id], onDelete: Cascade)
  account         Account       @relation(fields: [accountId], references: [id])

  @@index([journalId])
  @@index([accountId])
  @@map("journal_lines")
}

model User {
  id                    Int                    @id @default(autoincrement())
  name                  String?
  email                 String                 @unique
  password              String?
  role                  Role                   @default(MEMBER)
  auth0Id               String?                @unique @map("auth0_id")
  avatarUrl             String?                @map("avatar_url")
  phone                 String?                @map("phone")
  createdAt             DateTime               @default(now()) @map("created_at")
  isActive              Boolean                @default(true) @map("is_active")
  permissions           Json?
  tenantId              Int?                   @map("tenant_id")
  updatedAt             DateTime               @default(now()) @updatedAt @map("updated_at")
  assignedGoals         Goal[]
  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]
  tenant                Tenant?                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transfers             Transfer[]
  // Fixed Assets relations
  ownedAssets           FixedAsset[]           @relation("AssetOwner")
  createdAssets         FixedAsset[]           @relation("AssetCreator")

  resetPasswordOtp      String?                @map("reset_password_otp")
  resetPasswordExpires  DateTime?              @map("reset_password_expires")

  @@index([tenantId])
  @@index([auth0Id])
  @@map("users")
}

model Goal {
  id                  Int        @id @default(autoincrement())
  tenantId            Int
  name                String
  targetAmount        Decimal
  currentAmount       Decimal    @default(0)
  targetDate          DateTime?
  monthlyContribution Decimal?
  assignedUserId      Int?
  status              GoalStatus @default(ACTIVE)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  assignedUser        User?      @relation(fields: [assignedUserId], references: [id])
  tenant              Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("goals")
}

model Budget {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  category  String
  amount    Decimal
  month     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("budgets")
}

enum Role {
  OWNER
  ADMIN
  PARENT
  CHILD
  MEMBER
}

model Transaction {
  id              Int             @id @default(autoincrement())
  tenantId        Int             @map("tenant_id")
  userId          Int             @map("user_id")
  type            TransactionType
  amount          Decimal
  category        String
  description     String?
  date            DateTime        @default(now())
  paymentMethod   String?         @map("payment_method")
  notes           String?
  
  // Accounting Integration
  journalId       Int?            @map("journal_id")
  debitAccountId  Int?            @map("debit_account_id")
  creditAccountId Int?            @map("credit_account_id")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  // Relations
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  journal         Journal?        @relation(fields: [journalId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([date])
  @@index([journalId])
  @@map("transactions")
}

model Category {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  name      String
  type      String   // 'income' or 'expense'
  icon      String?
  color     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name, type])
  @@map("categories")
}

model PaymentMethod {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  name      String
  type      String   // 'cash', 'bank', 'mobile_money', 'card', etc.
  details   Json?    // Store account numbers, etc.
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model RecurringTransaction {
  id            Int             @id @default(autoincrement())
  tenantId      Int             @map("tenant_id")
  userId        Int             @map("user_id")
  type          TransactionType
  amount        Decimal
  category      String
  description   String?
  frequency     String          // 'daily', 'weekly', 'monthly', 'yearly'
  startDate     DateTime        @map("start_date")
  endDate       DateTime?       @map("end_date")
  lastProcessed DateTime?       @map("last_processed")
  isActive      Boolean         @default(true) @map("is_active")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("recurring_transactions")
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  PURCHASE
  SALE
  DEPOSIT
  WITHDRAWAL
  LIABILITY_INC  // Loan Disbursement - Money in, Debt up
  LIABILITY_DEC  // Loan Repayment - Money out, Debt down
}

// ============================================
// PROFESSIONAL ACCOUNTING MODELS
// ============================================

// Vendor/Supplier Management
model Vendor {
  id              Int        @id @default(autoincrement())
  tenantId        Int        @map("tenant_id")
  name            String
  email           String?
  phone           String?
  address         String?
  taxId           String?    @map("tax_id")
  paymentTerms    String?    @map("payment_terms") // "Net 30", "Due on Receipt"
  balance         Decimal    @default(0) // Current outstanding balance
  isActive        Boolean    @default(true) @map("is_active")
  logoUrl         String?    @map("logo_url")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  
  tenant          Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchases       Purchase[]
  expenses        Expense[]
  tags            VendorTag[]
  stats           VendorStats?
  
  @@index([tenantId])
  @@index([name])
  @@map("vendors")
}

model VendorTag {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  name      String
  vendors   Vendor[]
  
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  @@unique([tenantId, name])
  @@map("vendor_tags")
}

model VendorStats {
  id              Int      @id @default(autoincrement())
  vendorId        Int      @unique @map("vendor_id")
  totalPurchases  Decimal  @default(0) @map("total_purchases")
  totalPaid       Decimal  @default(0) @map("total_paid")
  lastPurchaseDate DateTime? @map("last_purchase_date")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  vendor          Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  @@map("vendor_stats")
}

// Purchase/Bill Management
model Purchase {
  id              Int              @id @default(autoincrement())
  tenantId        Int              @map("tenant_id")
  vendorId        Int?             @map("vendor_id")
  billNumber      String?          @map("bill_number") // Vendor's invoice number
  purchaseDate    DateTime         @default(now()) @map("purchase_date")
  dueDate         DateTime?        @map("due_date")
  status          PurchaseStatus   @default(UNPAID)
  subtotal        Decimal
  tax             Decimal          @default(0)
  discount        Decimal          @default(0)
  total           Decimal
  amountPaid      Decimal          @default(0) @map("amount_paid")
  notes           String?
  attachmentUrl   String?          @map("attachment_url")
  journalId       Int?             @map("journal_id")
  createdById     Int              @map("created_by_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  
  vatRate          Decimal          @default(16) @map("vat_rate")
  vatAmount        Decimal          @default(0) @map("vat_amount")
  amountBeforeVAT  Decimal          @default(0) @map("amount_before_vat")
  includesVAT      Boolean          @default(true) @map("includes_vat")
  
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendor          Vendor?          @relation(fields: [vendorId], references: [id])
  journal         Journal?         @relation(fields: [journalId], references: [id])
  items           PurchaseItem[]
  payments        PurchasePayment[]
  
  @@index([tenantId])
  @@index([vendorId])
  @@index([status])
  @@map("purchases")
}

enum PurchaseStatus {
  DRAFT
  UNPAID
  PARTIAL
  PAID
  CANCELLED
}

// Purchase Line Items
model PurchaseItem {
  id              Int      @id @default(autoincrement())
  purchaseId      Int      @map("purchase_id")
  description     String
  quantity        Decimal
  unitPrice       Decimal  @map("unit_price")
  amount          Decimal
  accountId       Int?     @map("account_id") // Expense/Asset account
  inventoryItemId Int?     @map("inventory_item_id")
  
  purchase        Purchase        @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem?  @relation(fields: [inventoryItemId], references: [id])
  
  @@index([purchaseId])
  @@map("purchase_items")
}

// Purchase Payments
model PurchasePayment {
  id              Int      @id @default(autoincrement())
  purchaseId      Int      @map("purchase_id")
  amount          Decimal
  paymentDate     DateTime @default(now()) @map("payment_date")
  paymentMethod   String   @map("payment_method")
  reference       String?  // Cheque number, transaction ID
  notes           String?
  journalId       Int?     @map("journal_id")
  
  purchase        Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  journal         Journal? @relation(fields: [journalId], references: [id])
  
  @@index([purchaseId])
  @@map("purchase_payments")
}

// ============================================
// INVENTORY / STOCK MANAGEMENT - WORLD CLASS
// ============================================

// Product Type Enum
enum ProductType {
  GOODS       // Physical items - Track stock
  SERVICE     // Services - No stock tracking
  BUNDLE      // Kit/Bundle of multiple items
}

// Inventory/Stock Management - Enhanced
model InventoryItem {
  id                  Int             @id @default(autoincrement())
  tenantId            Int             @map("tenant_id")
  
  // ========== IDENTIFICATION ==========
  sku                 String          // Stock Keeping Unit (Auto-generated if empty)
  barcode             String?         // EAN-13, UPC, or custom barcode
  name                String
  description         String?
  imageUrl            String?         @map("image_url") // Product photo
  
  // ========== CLASSIFICATION ==========
  productType         ProductType     @default(GOODS) @map("product_type")
  category            String?         // "Electronics", "Food", "Apparel"
  brand               String?         // "Samsung", "Nike"
  unit                String          @default("pcs") // "pcs", "kg", "liters", "box"
  
  // ========== PRICING ==========
  costPrice           Decimal         @map("cost_price") // Last purchase price
  weightedAvgCost     Decimal         @default(0) @map("weighted_avg_cost") // WAC for COGS accuracy
  sellingPrice        Decimal         @map("selling_price") // Default selling price
  minSellingPrice     Decimal?        @map("min_selling_price") // Floor price (prevent losses)
  wholesalePrice      Decimal?        @map("wholesale_price") // Bulk discount price
  taxRate             Decimal         @default(16) @map("tax_rate") // VAT rate (16% default for Kenya)
  isTaxInclusive      Boolean         @default(true) @map("is_tax_inclusive") // Price includes VAT?
  
  // ========== STOCK LEVELS ==========
  quantity            Decimal         @default(0) // Current stock on hand
  reservedQty         Decimal         @default(0) @map("reserved_qty") // Reserved for pending orders
  reorderLevel        Decimal?        @map("reorder_level") // Alert when stock falls below
  reorderQuantity     Decimal?        @map("reorder_quantity") // Suggested reorder amount
  maxStockLevel       Decimal?        @map("max_stock_level") // Prevent over-ordering
  
  // ========== ACCOUNTING LINKS ==========
  assetAccountId      Int             @map("asset_account_id") // Inventory Asset (1200)
  cogsAccountId       Int             @map("cogs_account_id")  // Cost of Goods Sold (5000)
  incomeAccountId     Int?            @map("income_account_id") // Sales Revenue (4100)
  
  // ========== METADATA ==========
  isActive            Boolean         @default(true) @map("is_active")
  isSellable          Boolean         @default(true) @map("is_sellable") // Can be sold
  isPurchasable       Boolean         @default(true) @map("is_purchasable") // Can be purchased
  notes               String?         // Internal notes
  metadata            Json?           // Flexible: Dimensions, Weight, Warranty, etc.
  createdById         Int?            @map("created_by_id")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  
  // ========== RELATIONS ==========
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  movements           StockMovement[]
  purchaseItems       PurchaseItem[]
  invoiceItems        InvoiceItem[]
  valuationHistory    InventoryValuation[] // Track cost changes over time
  
  @@unique([tenantId, sku])
  @@unique([tenantId, barcode])
  @@index([tenantId])
  @@index([productType])
  @@index([category])
  @@index([isActive])
  @@map("inventory_items")
}

// Inventory Valuation History - Track cost changes over time
model InventoryValuation {
  id              Int           @id @default(autoincrement())
  itemId          Int           @map("item_id")
  date            DateTime      @default(now())
  qtyBefore       Decimal       @map("qty_before")
  qtyAfter        Decimal       @map("qty_after")
  costBefore      Decimal       @map("cost_before") // WAC before transaction
  costAfter       Decimal       @map("cost_after")  // WAC after transaction
  transactionType String        @map("transaction_type") // "PURCHASE", "SALE", "ADJUSTMENT"
  reference       String?       // Purchase/Invoice ID
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  
  item            InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@index([itemId])
  @@index([date])
  @@map("inventory_valuations")
}

// Stock Movements - Enhanced Audit Trail
model StockMovement {
  id              Int          @id @default(autoincrement())
  tenantId        Int          @map("tenant_id")
  itemId          Int          @map("item_id")
  
  // Movement Details
  type            MovementType
  reason          MovementReason? // Specific reason for the movement
  quantity        Decimal      // Positive for IN, Negative for OUT
  
  // Cost Tracking
  unitCost        Decimal?     @map("unit_cost") // Cost at time of movement
  totalValue      Decimal?     @map("total_value") // quantity Ã— unitCost
  wacBefore       Decimal?     @map("wac_before") // Weighted Avg Cost before
  wacAfter        Decimal?     @map("wac_after")  // Weighted Avg Cost after
  
  // Running Balance (for audit trail)
  qtyBefore       Decimal?     @map("qty_before") // Stock level before movement
  qtyAfter        Decimal?     @map("qty_after")  // Stock level after movement
  
  // Source Reference
  reference       String?      // Generic reference
  sourceType      String?      @map("source_type") // "PURCHASE", "INVOICE", "ADJUSTMENT", "OPENING"
  sourceId        Int?         @map("source_id") // ID of the source document
  
  // Metadata
  date            DateTime     @default(now()) @map("date")
  notes           String?
  journalId       Int?         @map("journal_id")
  createdById     Int?         @map("created_by_id")
  createdAt       DateTime     @default(now()) @map("created_at")
  
  // Relations
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item            InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  journal         Journal?     @relation(fields: [journalId], references: [id])
  
  @@index([tenantId])
  @@index([itemId])
  @@index([date])
  @@index([sourceType, sourceId])
  @@map("stock_movements")
}

enum MovementType {
  IN          // Stock received (purchase, return from customer)
  OUT         // Stock sold or used
  ADJUSTMENT  // Manual count adjustment
  TRANSFER    // Transfer between locations/warehouses
  RETURN      // Return to supplier
}

enum MovementReason {
  PURCHASE          // Received from supplier
  SALE              // Sold to customer
  CUSTOMER_RETURN   // Customer returned goods
  SUPPLIER_RETURN   // Returned to supplier
  DAMAGED           // Damaged/broken goods
  EXPIRED           // Expired goods
  THEFT             // Stolen goods
  LOST              // Lost/missing
  FOUND             // Found (positive adjustment)
  COUNT_ADJUSTMENT  // Physical count variance
  OPENING_STOCK     // Initial stock entry
  PRODUCTION        // Used in production
  SAMPLE            // Given as sample
  TRANSFER_IN       // Received from another location
  TRANSFER_OUT      // Sent to another location
}

// Bank Transactions (Deposits, Cheques, Transfers)
model BankTransaction {
  id              Int                 @id @default(autoincrement())
  tenantId        Int                 @map("tenant_id")
  bankAccountId   Int                 @map("bank_account_id") // From Chart of Accounts
  type            BankTransactionType
  amount          Decimal
  date            DateTime            @default(now())
  chequeNumber    String?             @map("cheque_number")
  reference       String?
  payee           String?             // Who received/paid
  description     String
  status          BankStatus          @default(CLEARED)
  journalId       Int?                @map("journal_id")
  reconciled      Boolean             @default(false)
  reconciledDate  DateTime?           @map("reconciled_date")
  createdById     Int?                @map("created_by_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  journal         Journal?            @relation(fields: [journalId], references: [id])
  
  @@index([tenantId])
  @@index([bankAccountId])
  @@index([date])
  @@map("bank_transactions")
}

enum BankTransactionType {
  DEPOSIT
  WITHDRAWAL
  CHEQUE
  TRANSFER
  FEE
  INTEREST
}

enum BankStatus {
  PENDING
  CLEARED
  BOUNCED
  CANCELLED
}



// ============================================
// SALES & INVOICING - QuickBooks Style
// ============================================

// Customers (like Vendors but for sales)
model Customer {
  id            Int       @id @default(autoincrement())
  tenantId      Int       @map("tenant_id")
  name          String
  companyName   String?   @map("company_name") // Business name if different from contact name
  email         String?
  phone         String?
  alternatePhone String?  @map("alternate_phone")
  address       String?
  city          String?
  state         String?
  zipCode       String?   @map("zip_code")
  country       String?   @default("Kenya")
  paymentTerms  String?   @default("Net 30") @map("payment_terms") // Net 30, Due on Receipt, etc.
  creditLimit   Decimal?  @map("credit_limit")
  balance       Decimal   @default(0) // Amount owed by customer
  taxNumber     String?   @map("tax_number") // VAT number, tax ID
  taxId         String?   @map("tax_id") // Business registration number
  website       String?
  contactPerson String?   @map("contact_person") // Primary contact name
  position      String?   // Contact person's position/title
  
  // Business fields
  businessType  String?   @map("business_type") // retail, wholesale, corporate, etc.
  industry      String?   // manufacturing, services, retail, etc.
  
  // Financial tracking
  totalSales    Decimal   @default(0) @map("total_sales") // Lifetime sales
  lastSaleDate  DateTime? @map("last_sale_date")
  firstSaleDate DateTime? @map("first_sale_date")
  
  notes         String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices      Invoice[]
  receipts      Receipt[]
  
  @@index([tenantId])
  @@index([name])
  @@index([companyName])
  @@index([email])
  @@index([taxNumber])
  @@index([businessType])
  @@map("customers")
}

// Sales Invoices
model Invoice {
  id            Int              @id @default(autoincrement())
  tenantId      Int              @map("tenant_id")
  customerId    Int              @map("customer_id")
  invoiceNumber String?          @map("invoice_number")
  invoiceDate   DateTime         @map("invoice_date")
  dueDate       DateTime?        @map("due_date")
  subtotal      Decimal
  tax           Decimal          @default(0)
  discount      Decimal          @default(0)
  total         Decimal
  amountPaid    Decimal          @default(0) @map("amount_paid")
  status        InvoiceStatus    @default(UNPAID)
  notes         String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  
  vatRate          Decimal          @default(16) @map("vat_rate")
  vatAmount        Decimal          @default(0) @map("vat_amount")
  amountBeforeVAT  Decimal          @default(0) @map("amount_before_vat")
  includesVAT      Boolean          @default(true) @map("includes_vat")
  
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer      Customer         @relation(fields: [customerId], references: [id])
  items         InvoiceItem[]
  payments      InvoicePayment[]
  journals      Journal[]
  receipts      Receipt[]
  
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceDate])
  @@map("invoices")
}

// ============================================
// RECEIPTS & INCOME
// ============================================

model Receipt {
  id              Int       @id @default(autoincrement())
  tenantId        Int       @map("tenant_id")
  receiptNumber   String    @map("receipt_number")
  date            DateTime
  amount          Decimal
  paymentMethod   String    @map("payment_method") // Cash, Bank, M-Pesa, Airtel Money
  customerId      Int?      @map("customer_id")
  invoiceId       Int?      @map("invoice_id")
  category        String?
  description     String?
  reference       String?   // M-Pesa code, cheque number
  createdAt       DateTime  @default(now()) @map("created_at")
  
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  customer        Customer? @relation(fields: [customerId], references: [id])
  invoice         Invoice?  @relation(fields: [invoiceId], references: [id])
  
  @@index([tenantId])
  @@index([date])
  @@map("receipts")
}

// ============================================
// EXPENSES
// ============================================

model Expense {
  id              Int       @id @default(autoincrement())
  tenantId        Int       @map("tenant_id")
  expenseNumber   String    @map("expense_number")
  date            DateTime
  amount          Decimal
  vatAmount       Decimal   @default(0) @map("vat_amount")
  totalAmount     Decimal   @map("total_amount")
  category        String    // Rent, Utilities, Salaries, etc.
  vendorId        Int?      @map("vendor_id")
  paymentMethod   String    @map("payment_method")
  description     String?
  reference       String?
  receiptPhoto    String?   @map("receipt_photo")
  accountId       Int?      @map("account_id") // Expense account
  createdAt       DateTime  @default(now()) @map("created_at")
  
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  vendor          Vendor?   @relation(fields: [vendorId], references: [id])
  account         Account?  @relation(fields: [accountId], references: [id])
  
  @@index([tenantId])
  @@index([date])
  @@map("expenses")
}

model ExpenseCategory {
  id              Int       @id @default(autoincrement())
  tenantId        Int       @map("tenant_id")
  name            String
  description     String?
  accountId       Int?      @map("account_id") // Default expense account
  isActive        Boolean   @default(true) @map("is_active")
  
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  account         Account?  @relation(fields: [accountId], references: [id])
  
  @@map("expense_categories")
}

// Invoice Line Items
model InvoiceItem {
  id              Int            @id @default(autoincrement())
  invoiceId       Int            @map("invoice_id")
  description     String
  quantity        Decimal
  unitPrice       Decimal        @map("unit_price")
  amount          Decimal
  accountId       Int?           @map("account_id") // Revenue account
  inventoryItemId Int?           @map("inventory_item_id")
  
  invoice         Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  account         Account?       @relation(fields: [accountId], references: [id])
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  
  @@index([invoiceId])
  @@map("invoice_items")
}

// Invoice Payments
model InvoicePayment {
  id            Int       @id @default(autoincrement())
  invoiceId     Int       @map("invoice_id")
  amount        Decimal
  paymentDate   DateTime  @map("payment_date")
  paymentMethod String    @map("payment_method")
  bankAccountId Int?      @map("bank_account_id")
  reference     String?
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  bankAccount   Account?  @relation(fields: [bankAccountId], references: [id])
  journals      Journal[]
  
  @@index([invoiceId])
  @@index([paymentDate])
  @@map("invoice_payments")
}

// Invoice Status
enum InvoiceStatus {
  DRAFT
  UNPAID
  PARTIAL
  PAID
  CANCELLED
  OVERDUE
}

// ============================================
// TRANSFER MANAGEMENT - Money Movement Between Accounts
// ============================================

model Transfer {
  id              Int      @id @default(autoincrement())
  tenantId        Int      @map("tenant_id")
  fromAccountId   Int      @map("from_account_id")
  toAccountId     Int      @map("to_account_id")
  amount          Decimal  // Amount transferred (arriving at destination)
  fee             Decimal  @default(0) // Transfer/bank fee
  date            DateTime @default(now())
  reference       String?  // Transaction reference
  description     String?
  journalId       Int?     @map("journal_id")
  createdById     Int?     @map("created_by_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fromAccount     Account  @relation("TransferFromAccount", fields: [fromAccountId], references: [id])
  toAccount       Account  @relation("TransferToAccount", fields: [toAccountId], references: [id])
  journal         Journal? @relation(fields: [journalId], references: [id])
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  @@index([tenantId])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([date])
  @@map("transfers")
}

// ============================================
// FIXED ASSETS MANAGEMENT - Family Wealth Tracker
// ============================================

model FixedAsset {
  id                  Int           @id @default(autoincrement())
  tenantId            Int           @map("tenant_id")
  
  // Identity
  name                String        // e.g., "Toyota Vitz - KCD 123G"
  category            String        // e.g., "Motor Vehicle", "Electronics"
  assetAccountId      Int           @map("asset_account_id") // Links to COA (1510, 1520, etc.)
  serialNumber        String?       @map("serial_number") // VIN, Chassis, Serial
  familyOwnerId       Int?          @map("family_owner_id") // Which family member owns it
  
  // Financials
  purchaseDate        DateTime      @map("purchase_date")
  purchasePrice       Decimal       @map("purchase_price")
  quantity            Decimal?      @default(1) // Number of units (e.g. 500 Shares)
  unitCost            Decimal?      // Cost per unit
  currentValue        Decimal       @map("current_value") // Updated via depreciation
  paidFromAccountId   Int?          @map("paid_from_account_id") // Cash/Bank account
  financeAccountId    Int?          @map("finance_account_id") // Loan/Liability account
  cashPortion         Decimal?      @map("cash_portion") // If split payment
  financePortion      Decimal?      @map("finance_portion") // If split payment
  vendor              String?       // Supplier name
  
  // Lifecycle - Warranty
  trackWarranty       Boolean       @default(false) @map("track_warranty")
  warrantyExpiry      DateTime?     @map("warranty_expiry")
  warrantyNotified    Boolean       @default(false) @map("warranty_notified")
  
  // Lifecycle - Depreciation
  isDepreciating      Boolean       @default(false) @map("is_depreciating")
  lifespanYears       Int?          @map("lifespan_years")
  salvageValue        Decimal?      @map("salvage_value") // Value at end of life
  depreciationMethod  String?       @map("depreciation_method") // "straight_line", "manual"
  accumDepAccountId   Int?          @map("accum_dep_account_id") // Links to 1710, 1730, etc.
  depreciationExpAccId Int?         @map("depreciation_exp_acc_id") // Links to 6910, 6930, etc.
  totalDepreciation   Decimal       @default(0) @map("total_depreciation")
  
  // Status
  status              AssetStatus   @default(ACTIVE)
  disposalDate        DateTime?     @map("disposal_date")
  disposalPrice       Decimal?      @map("disposal_price")
  disposalAccountId   Int?          @map("disposal_account_id") // Where money went
  
  // Documents
  photoUrl            String?       @map("photo_url")
  documents           Json?         // Array of document URLs
  
  // Journal tracking
  purchaseJournalId   Int?          @map("purchase_journal_id")
  
  // Metadata
  notes               String?
  createdById         Int?          @map("created_by_id")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  
  // Relations
  tenant              Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetAccount        Account       @relation("AssetAccount", fields: [assetAccountId], references: [id])
  paidFromAccount     Account?      @relation("PaidFromAccount", fields: [paidFromAccountId], references: [id])
  financeAccount      Account?      @relation("FinanceAccount", fields: [financeAccountId], references: [id])
  accumDepAccount     Account?      @relation("AccumDepAccount", fields: [accumDepAccountId], references: [id])
  depreciationExpAcc  Account?      @relation("DepreciationExpAccount", fields: [depreciationExpAccId], references: [id])
  disposalAccount     Account?      @relation("DisposalAccount", fields: [disposalAccountId], references: [id])
  familyOwner         User?         @relation("AssetOwner", fields: [familyOwnerId], references: [id])
  createdBy           User?         @relation("AssetCreator", fields: [createdById], references: [id])
  depreciationEntries AssetDepreciation[]
  
  @@index([tenantId])
  @@index([assetAccountId])
  @@index([status])
  @@index([purchaseDate])
  @@map("fixed_assets")
}

enum AssetStatus {
  ACTIVE
  DISPOSED
  SOLD
  WRITTEN_OFF
}

model AssetDepreciation {
  id              Int         @id @default(autoincrement())
  fixedAssetId    Int         @map("fixed_asset_id")
  date            DateTime    @default(now())
  previousValue   Decimal     @map("previous_value")
  newValue        Decimal     @map("new_value")
  depreciationAmt Decimal     @map("depreciation_amount")
  journalId       Int?        @map("journal_id")
  notes           String?
  createdAt       DateTime    @default(now()) @map("created_at")
  
  // Relations
  fixedAsset      FixedAsset  @relation(fields: [fixedAssetId], references: [id], onDelete: Cascade)
  journal         Journal?    @relation("DepreciationJournal", fields: [journalId], references: [id])
  
  @@index([fixedAssetId])
  @@map("asset_depreciations")
}

// ============================================
// CHEQUE MANAGEMENT - Revolutionary Feature
// ============================================

model Cheque {
  id              Int           @id @default(autoincrement())
  tenantId        Int           @map("tenant_id")
  chequeNumber    String        @map("cheque_number")
  payee           String
  amount          Decimal
  dueDate         DateTime      @map("due_date") // Post-dated cheque date
  bankAccountId   Int           @map("bank_account_id") // Which bank account
  accountNumber   String?       @map("account_number") // Last 4 digits for display
  purpose         String        // School Fees, Rent, etc.
  status          ChequeStatus  @default(PENDING)
  
  // Clearance tracking
  dateCleared     DateTime?     @map("date_cleared")
  clearedById     Int?          @map("cleared_by_id")
  
  // Accounting integration
  writeJournalId  Int?          @map("write_journal_id") // Journal when cheque written
  clearJournalId  Int?          @map("clear_journal_id") // Journal when cleared
  
  // Additional metadata
  notes           String?
  reference       String?       // Transaction reference
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
  @@index([bankAccountId])
  @@map("cheques")
}

enum ChequeStatus {
  PENDING   // Written but not cleared
  CLEARED   // Cleared by bank
  BOUNCED   // Returned/bounced
  VOIDED    // Cancelled/voided
}

// ============================================
// DEBT TRACKER / LENDING MANAGER
// ============================================

model Loan {
  id              String    @id @default(cuid())
  tenantId        Int       @map("tenant_id")
  
  // Who involves?
  borrowerName    String    @map("borrower_name") // e.g., "Cousin Ben"
  phoneNumber     String?   @map("phone_number")  // For reminders
  
  // Loan Details
  type            String    // 'LENT' (Asset) or 'BORROWED' (Liability)
  principalAmount Decimal   @db.Decimal(10, 2) @map("principal_amount")
  balance         Decimal   @db.Decimal(10, 2) // Current outstanding
  
  // Dates
  issueDate       DateTime  @map("issue_date")
  dueDate         DateTime? @map("due_date")
  
  // Links to Accounting
  accountId       Int       @map("account_id") // The tracking account (e.g., 1200 for Lent, 2010 for Borrowed)
  
  // Relations
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions    LoanTransaction[]
  
  status          String    // 'ACTIVE', 'PAID', 'WRITTEN_OFF'
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("loans")
}

model LoanTransaction {
  id              String   @id @default(cuid())
  loanId          String   @map("loan_id")
  loan            Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  date            DateTime
  amount          Decimal  @db.Decimal(10, 2)
  type            String   // 'REPAYMENT', 'INTEREST', 'ADJUSTMENT'
  
  journalId       Int      @map("journal_id")
  journal         Journal  @relation(fields: [journalId], references: [id])

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([loanId])
  @@map("loan_transactions")
}
